# openapi-ts-json-schema

[![Build Status][ci-badge]][ci]
[![Npm version][npm-version-badge]][npm]
[![Coveralls][coveralls-badge]][coveralls]

Generate JSON schema TypeScript files (`.ts`) from OpenAPI definitions which can be natively used to infer types from (with [`json-schema-to-ts`](https://github.com/ThomasAribart/json-schema-to-ts) or [`fastify-type-provider-json-schema-to-ts`](https://github.com/fastify/fastify-type-provider-json-schema-to-ts)).

Given an OpenAPI definition file, `openapi-ts-json-schema` will:

- Resolve external/remote `$ref`s and dereference them with [`@apidevtools/json-schema-ref-parser`](https://github.com/APIDevTools/json-schema-ref-parser)
- Optionally inline, import or keep local `$ref`s
- Convert to JSON schema with [`@openapi-contrib/openapi-schema-to-json-schema`](https://github.com/openapi-contrib/openapi-schema-to-json-schema) and [`openapi-jsonschema-parameters`](https://www.npmjs.com/package/openapi-jsonschema-parameters)
- Generate one TypeScript JSON schema file for each definition (`.ts` files with `as const` assertion)
- Store schemas in a folder structure reflecting the original OpenAPI definition structure

## Installation

```
npm i openapi-ts-json-schema -D
```

## Usage

```ts
import { openapiToTsJsonSchema } from 'openapi-ts-json-schema';

const { outputPath } = await openapiToTsJsonSchema({
  openApiSchema: 'path/to/open-api-specs.yaml',
  definitionPathsToGenerateFrom: ['paths', 'components.schemas'],
});
```

...then in your code:

```ts
import Ajv from 'ajv';
import { FromSchema } from 'json-schema-to-ts';
import myModelSchema from 'path/to/schemas-autogenerated/components/schemas/MyModel.ts';

// Use generated JSON schemas as usual
const ajv = new Ajv();
const valid = ajv.validate(myModelSchema, { hello: 'World' });

// Use generated JSON schemas to infer model types from
type MyModel = FromSchema<typeof myModelSchema>;
```

## Options

| Property                                       | Type                                       | Description                                                                                                                                                  | Default    |
| ---------------------------------------------- | ------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------ | ---------- |
| **openApiSchema** _(required)_                 | `string`                                   | Path to the OpenApi file (supports yaml and json).                                                                                                           | -          |
| **definitionPathsToGenerateFrom** _(required)_ | `string[]`                                 | OpenApi definition object paths to generate the JSON schemas from. Only matching paths will be generated. (Supports dot notation: `["components.schemas"]`). | -          |
| **refHandling**                                | `"inline" \| "import" \| "keep"`           | `"inline"`: inline `$ref` schemas. <br/>`"import"`: generate and import `$ref` schemas.<br/>`"keep"`: keep `$ref` value.                                     | `"inline"` |
| **schemaPatcher**                              | `(params: { schema: JSONSchema }) => void` | Dynamically patch generated JSON schemas. The provided function will be invoked against every single JSON schema node.                                       | -          |
| **outputPath**                                 | `string`                                   | Path where the generated schemas will be saved. Defaults to `/schemas-autogenerated` in same directory as provided `openApiSchema`.                          | -          |
| **plugins**                                    | `ReturnType<Plugin>[]`                     | A set of optional plugin to generate any extra custom. See [plugins docs](./docs/plugins.md). output.                                                        | -          |
| **silent**                                     | `boolean`                                  | Don't `console.log` user messages.                                                                                                                           | `false`    |

### Notes

Generated JSON schema path names get escaped in order to be valid file system names.

Circular `$ref`s can be technically resolved with "import" `refHandling` option. But TS will stop the type recursion and type the schema as `any`. See [relevant tests](https://github.com/toomuchdesign/openapi-ts-json-schema/blob/master/test/circularReference.test.ts).

Take a look at the [Developer's notes](./docs/developer-notes.md) for a few more in-depth explanations.

## Return values

Beside generating the expected schema files under `outputPath`, `openapiToTsJsonSchema` returns the following data:

```ts
{
  // The path where the schemas are generated
  outputPath: string;
  metaData: {
    // Meta data of the generated schemas
    schemas: Map<
      string,
      {
        schemaId: string;
        schemaFileName: string;
        // Valid filename for given schema (without extension).
        schemaAbsoluteDirName: string;
        // Absolute path pointing to schema folder
        schemaAbsolutePath: string;
        // Absolute path pointing to schema file
        schemaAbsoluteImportPath: string;
        // Absolute import path (without extension)
        schemaUniqueName: string;
        // Unique JavaScript identifier used as import name
        schema: JSONSchema;
        // The actual JSON schema
        isRef: boolean;
        // True is schemas is used as a `$ref`
      }
    >;
  }
}
```

## Plugins

`metaData` output can be used to dynamically generate extra custom output based on the generated schemas.

`openapi-ts-json-schema` currently ships with one plugin specifically designed to better integrate with [Fastify](https://fastify.dev/).

Read more about plugins in the [dedicated readme](./docs/plugins.md).

## Todo

- Consider merging "operation" and "path" parameters definition
- Consider removing required `definitionPathsToGenerateFrom` option in favour of exporting the whole OpenAPI definitions based on the structure defined in specs

[ci-badge]: https://github.com/toomuchdesign/openapi-ts-json-schema/actions/workflows/ci.yml/badge.svg
[ci]: https://github.com/toomuchdesign/openapi-ts-json-schema/actions/workflows/ci.yml
[coveralls-badge]: https://coveralls.io/repos/github/toomuchdesign/openapi-ts-json-schema/badge.svg?branch=master
[coveralls]: https://coveralls.io/github/toomuchdesign/openapi-ts-json-schema?branch=master
[npm]: https://www.npmjs.com/package/openapi-ts-json-schema
[npm-version-badge]: https://img.shields.io/npm/v/openapi-ts-json-schema.svg
