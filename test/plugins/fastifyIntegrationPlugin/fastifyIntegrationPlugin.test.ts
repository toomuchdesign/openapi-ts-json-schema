import fs from 'fs/promises';
import path from 'path';

import { describe, expect, it } from 'vitest';

import {
  fastifyIntegrationPlugin,
  openapiToTsJsonSchema,
} from '../../../src/index.js';
import { formatTypeScript } from '../../../src/utils/index.js';
import { fixturesPath, makeTestOutputPath } from '../../test-utils/index.js';

describe('fastifyIntegration plugin', () => {
  it('generates expected file', async () => {
    const { outputPath } = await openapiToTsJsonSchema({
      openApiDocument: path.resolve(fixturesPath, 'complex/specs.yaml'),
      outputPath: makeTestOutputPath('plugin-fastify'),
      definitionPathsToGenerateFrom: ['components.schemas', 'paths'],
      plugins: [fastifyIntegrationPlugin()],
      silent: true,
    });

    const actualAsText = await fs.readFile(
      path.resolve(outputPath, 'fastify-integration.ts'),
      {
        encoding: 'utf8',
      },
    );

    // @TODO find a better way to assert against generated types
    const expectedAsText = await formatTypeScript(`
      // File autogenerated by "openapi-ts-json-schema". Do not edit :)
      import { with$id as componentsSchemasJanuary } from "./components/schemas/January.js";
      import { with$id as componentsSchemasFebruary } from "./components/schemas/February.js";
      import { with$id as componentsSchemasMarch } from "./components/schemas/March.js";
      import { with$id as componentsSchemasAnswer } from "./components/schemas/Answer.js";

      // RefSchemas type: tuple of $ref schema types to enable json-schema-to-ts hydrate $refs via "references" option
      export type RefSchemas = [
        typeof componentsSchemasJanuary,
        typeof componentsSchemasFebruary,
        typeof componentsSchemasMarch,
        typeof componentsSchemasAnswer,
      ];

      // schemas: array of JSON schemas to be registered with "fastify.addSchema"
      export const schemas = [
        componentsSchemasJanuary,
        componentsSchemasFebruary,
        componentsSchemasMarch,
        componentsSchemasAnswer,
      ]`);

    expect(actualAsText).toBe(expectedAsText);

    // $ref schemas
    const answerSchema = await import(
      path.resolve(outputPath, 'components/schemas/Answer')
    );
    const januarySchema = await import(
      path.resolve(outputPath, 'components/schemas/January')
    );
    const februarySchema = await import(
      path.resolve(outputPath, 'components/schemas/February')
    );
    // non-$ref schemas
    const marchSchema = await import(
      path.resolve(outputPath, 'components/schemas/March')
    );

    const actual = await import(
      path.resolve(outputPath, 'fastify-integration')
    );

    expect(actual.schemas).toEqual([
      januarySchema.with$id,
      februarySchema.with$id,
      marchSchema.with$id,
      answerSchema.with$id,
    ]);
  });

  describe('"schemaFilter" option', () => {
    it('exposes only filtered schemas', async () => {
      const { outputPath } = await openapiToTsJsonSchema({
        openApiDocument: path.resolve(fixturesPath, 'complex/specs.yaml'),
        outputPath: makeTestOutputPath('plugin-fastify-schemaFilter-option'),
        definitionPathsToGenerateFrom: ['components.schemas', 'paths'],
        plugins: [
          fastifyIntegrationPlugin({
            schemaFilter: ({ id }) =>
              id.includes('January') || id.includes('March'),
          }),
        ],
        silent: true,
      });

      const actual = await import(
        path.resolve(outputPath, 'fastify-integration')
      );
      const januarySchema = await import(
        path.resolve(outputPath, 'components/schemas/January')
      );
      const marchSchema = await import(
        path.resolve(outputPath, 'components/schemas/March')
      );

      expect(actual.schemas).toEqual([
        januarySchema.with$id,
        marchSchema.with$id,
      ]);
    });
  });
});
