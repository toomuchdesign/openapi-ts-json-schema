import fs from 'fs';
import { rm } from 'node:fs/promises';
import path from 'path';

import { afterEach, describe, expect, it } from 'vitest';

import { openapiToTsJsonSchema } from '../src/index.js';
import { fixturesPath, testTempPath } from './test-utils/index.js';

describe('"outputPath" option', () => {
  it('saves generated schemas to provided path', async () => {
    const customOutputPath = path.resolve(testTempPath, 'custom-path');

    const { outputPath } = await openapiToTsJsonSchema({
      openApiDocument: path.resolve(fixturesPath, 'ref-property/specs.yaml'),
      targets: {
        collections: ['components.schemas'],
      },
      outputPath: customOutputPath,
      refHandling: 'import',
      silent: true,
    });

    expect(outputPath).toBe(customOutputPath);

    const expectedGeneratedSchemaPath = path.resolve(
      outputPath,
      'components/schemas',
      'Answer.ts',
    );
    expect(fs.existsSync(expectedGeneratedSchemaPath)).toBe(true);
  });

  describe('no value provided', () => {
    afterEach(async () => {});

    it('saves generated schemas in a "schemas-autogenerated" folder next to open api schema', async () => {
      const { outputPath } = await openapiToTsJsonSchema({
        openApiDocument: path.resolve(fixturesPath, 'ref-property/specs.yaml'),
        targets: {
          collections: ['components.schemas'],
        },
        refHandling: 'import',
        silent: true,
      });

      const expectedOutputPath = path.resolve(
        fixturesPath,
        'ref-property/schemas-autogenerated',
      );
      expect(outputPath).toBe(expectedOutputPath);

      const expectedGeneratedSchemaPath = path.resolve(
        expectedOutputPath,
        'components/schemas',
        'Answer.ts',
      );

      expect(fs.existsSync(expectedGeneratedSchemaPath)).toBe(true);

      // Clean up after test
      await rm(outputPath, { recursive: true, force: true });
    });
  });
});
